name: Autograding

on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout å­¸ç”Ÿç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£ Python ä¾è³´å¥—ä»¶
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: å®‰è£ C++ ç·¨è­¯å™¨
        run: |
          sudo apt-get update
          sudo apt-get install -y g++

      - name: é©—è­‰ç’°å¢ƒè¨­å®š
        run: |
          python --version
          g++ --version
          python scripts/verify_python_setup.py || true

      - name: åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        id: run_tests
        run: |
          python run_tests.py > test_results.txt 2>&1
          cat test_results.txt

      - name: æ”¶é›†æ¸¬è©¦çµæœ
        if: always()
        run: |
          echo "## æ¸¬è©¦çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat test_results.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "build" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## åˆ†æ•¸çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            total_score=0
            max_score=0
            
            for score_file in build/*.score; do
              if [ -f "$score_file" ]; then
                problem=$(basename "$score_file" .score)
                read score max < "$score_file"
                total_score=$((total_score + score))
                max_score=$((max_score + max))
                
                if [ "$score" -eq "$max" ]; then
                  status="âœ…"
                else
                  status="âŒ"
                fi
                
                echo "- $status **$problem**: $score / $max" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç¸½åˆ†: $total_score / $max_score" >> $GITHUB_STEP_SUMMARY
            
            # å„²å­˜ç¸½åˆ†ä¾›å¾ŒçºŒä½¿ç”¨
            echo "TOTAL_SCORE=$total_score" >> $GITHUB_ENV
            echo "MAX_SCORE=$max_score" >> $GITHUB_ENV
          fi

      - name: ä¸Šå‚³æ¸¬è©¦å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test_results.txt
            build/*.score
            build/*.log
          retention-days: 30

      - name: å»ºç«‹è©•åˆ†è¨»è§£
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ğŸ¤– è‡ªå‹•è©•åˆ†çµæœ\n\n';
            
            if (fs.existsSync('build')) {
              const files = fs.readdirSync('build').filter(f => f.endsWith('.score'));
              
              comment += '| é¡Œç›® | å¾—åˆ† | ç‹€æ…‹ |\n';
              comment += '|------|------|------|\n';
              
              let totalScore = 0;
              let maxScore = 0;
              
              files.forEach(file => {
                const content = fs.readFileSync(`build/${file}`, 'utf8').trim().split(' ');
                const score = parseInt(content[0]);
                const max = parseInt(content[1]);
                const problem = file.replace('.score', '');
                const status = score === max ? 'âœ…' : 'âŒ';
                
                totalScore += score;
                maxScore += max;
                
                comment += `| ${problem} | ${score}/${max} | ${status} |\n`;
              });
              
              comment += `\n### ç¸½åˆ†: ${totalScore} / ${maxScore}\n\n`;
              
              if (totalScore === maxScore) {
                comment += 'ğŸ‰ **æ­å–œï¼æ‰€æœ‰æ¸¬è©¦éƒ½é€šéäº†ï¼**\n';
              } else {
                comment += 'âš ï¸ é‚„æœ‰ä¸€äº›æ¸¬è©¦æœªé€šéï¼Œè«‹æª¢æŸ¥æ¸¬è©¦çµæœä¸¦ä¿®æ­£ç¨‹å¼ç¢¼ã€‚\n';
              }
            } else {
              comment += 'âŒ ç„¡æ³•è®€å–æ¸¬è©¦çµæœ\n';
            }
            
            comment += '\n---\n';
            comment += 'è©³ç´°æ¸¬è©¦æ—¥èªŒè«‹æŸ¥çœ‹ Actions é é¢çš„ Artifactsã€‚\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: æª¢æŸ¥æ˜¯å¦å…¨éƒ¨é€šé
        if: always()
        run: |
          if [ -n "$TOTAL_SCORE" ] && [ -n "$MAX_SCORE" ]; then
            if [ "$TOTAL_SCORE" -eq "$MAX_SCORE" ]; then
              echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼"
              exit 0
            else
              echo "âŒ æœ‰æ¸¬è©¦æœªé€šé"
              echo "å¾—åˆ†: $TOTAL_SCORE / $MAX_SCORE"
              exit 1
            fi
          else
            echo "âš ï¸ ç„¡æ³•åˆ¤æ–·æ¸¬è©¦çµæœ"
            exit 1
          fi
